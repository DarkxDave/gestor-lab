<% layout('partials/layout') %>
<h2>RAM: Enumeración de Aerobios Mesófilos</h2>
<form method="get" action="/form-ram" class="row g-2 mb-3">
  <div class="col-auto">
    <input type="text" name="sample_id" class="form-control" placeholder="sample_id" value="<%= sampleId || '' %>" required>
  </div>
  <div class="col-auto">
    <button class="btn btn-outline-info" type="submit">Cargar</button>
  </div>
  <div class="col-auto">
    <a class="btn btn-outline-secondary" href="/samples">Muestras</a>
  </div>
  <div class="col-auto">
    <a class="btn btn-outline-success" href="<%= sampleId ? ('/export/all-forms?sample_id=' + encodeURIComponent(sampleId)) : '#' %>" data-export-tpa>Exportar Excel</a>
  </div>
  <div class="col-auto">
    <button class="btn btn-outline-primary" type="button" id="btnSaveAll">Guardar en todas</button>
  </div>
</form>

<%- include('partials/formTabs', { active: 'ram', sampleId }) %>

<!-- Encabezado visual -->
<div class="card p-3 mb-3">
  <div class="row g-2 align-items-center">
    <div class="col-12">
      <div class="text-center fw-bold" style="font-size: 1.25rem;">TRAZABILIDAD ANÁLISIS: ENUMERACIÓN DE AEROBIOS MESÓFILOS (NCh 2659.Of 2002)</div>
    </div>
    <div class="col-12">
      <div class="text-center fw-bold">R-PR-SVVM-M-4-11 / 15-02-23</div>
    </div>
  </div>
</div>

<!-- Banda de ID -->
<div class="card p-3 mb-4">
  <div class="row g-2 align-items-center">
    <div class="col-auto"><div class="border fw-bold px-3 py-2">ALI</div></div>
    <div class="col-auto"><div class="border fw-bold px-4 py-2 bg-light"><%= sampleId || '' %></div></div>
  </div>
</div>

<!-- Cuerpo RAM -->
<div class="card p-3 mb-4">
  <form method="post" action="/form-ram/save">
    <input type="hidden" name="sample_id" value="<%= sampleId || '' %>">

    <!-- Inicio/Término -->
    <div class="mb-4">
      <div class="bg-light border fw-bold text-center py-2 px-3 rounded-top">Fechas y análisis</div>
      <div class="border border-top-0 rounded-bottom p-3">
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="border rounded p-3 h-100">
              <div class="fw-bold mb-2">Inicio Incubación (Día/Mes/Hora/Analista):</div>
              <div class="row g-2">
                <div class="col-5 col-md-4">
                  <label class="form-label small mb-1">Fecha</label>
                  <input type="date" name="inicio_incubacion_fecha" class="form-control" value="<%= (data && data.inicio_incubacion_fecha) || '' %>">
                </div>
                <div class="col-4 col-md-3">
                  <label class="form-label small mb-1">Hora</label>
                  <input type="time" name="inicio_incubacion_hora" class="form-control" value="<%= (data && data.inicio_incubacion_hora) || '' %>">
                </div>
                <div class="col-12 col-md-5">
                  <label class="form-label small mb-1">Analista</label>
                  <input type="text" name="inicio_incubacion_analista" class="form-control" value="<%= (data && data.inicio_incubacion_analista) || '' %>">
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="border rounded p-3 h-100">
              <div class="fw-bold mb-2">Término Análisis (Día/Mes/Hora/Analista):</div>
              <div class="row g-2">
                <div class="col-5 col-md-4">
                  <label class="form-label small mb-1">Fecha</label>
                  <input type="date" name="termino_analisis_fecha" class="form-control" value="<%= (data && data.termino_analisis_fecha) || '' %>">
                </div>
                <div class="col-4 col-md-3">
                  <label class="form-label small mb-1">Hora</label>
                  <input type="time" name="termino_analisis_hora" class="form-control" value="<%= (data && data.termino_analisis_hora) || '' %>">
                </div>
                <div class="col-12 col-md-5">
                  <label class="form-label small mb-1">Analista</label>
                  <input type="text" name="termino_analisis_analista" class="form-control" value="<%= (data && data.termino_analisis_analista) || '' %>">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Set de Análisis -->
    <div class="mb-4">
      <div class="bg-light border fw-bold text-center py-2 px-3 rounded-top">Set de Análisis</div>
      <div class="border border-top-0 rounded-bottom p-3">
        <div class="table-responsive">
          <table class="table table-bordered align-middle mb-0">
            <tbody>
              <tr>
                <td class="fw-semibold" style="width: 24%">Control Ambiental Pesado: T°:</td>
                <td style="width: 16%"><input type="text" name="cc2_pesado_temp" class="form-control" value="<%= (data && data.cc2_pesado_temp) || '' %>"></td>
                <td style="width: 8%">UFC:</td>
                <td style="width: 16%"><input type="text" name="cc2_pesado_ufc" class="form-control" value="<%= (data && data.cc2_pesado_ufc) || '' %>"></td>
                <td class="fw-semibold" style="width: 20%">Control ambiental Siembra:</td>
                <td><input type="text" name="cc2_siembra" class="form-control" value="<%= (data && data.cc2_siembra) || '' %>"></td>
              </tr>
              <tr>
                <td class="fw-semibold">Hora inicio:</td>
                <td><input type="time" name="cc2_hora_inicio" class="form-control" value="<%= (data && data.cc2_hora_inicio) || '' %>"></td>
                <td class="fw-semibold">Hora término:</td>
                <td><input type="time" name="cc2_hora_termino" class="form-control" value="<%= (data && data.cc2_hora_termino) || '' %>"></td>
                <td class="fw-semibold">T°:</td>
                <td><input type="text" name="cc2_temp" class="form-control" value="<%= (data && data.cc2_temp) || '' %>"></td>
              </tr>
              <tr>
                <td class="fw-semibold">Control de siembra E. Coli (UFC):</td>
                <td colspan="2"><input type="text" name="cc2_ecoli_ufc" class="form-control" value="<%= (data && data.cc2_ecoli_ufc) || '' %>"></td>
                <td class="fw-semibold">Blanco (UFC):</td>
                <td colspan="2"><input type="text" name="cc2_blanco_ufc" class="form-control" value="<%= (data && data.cc2_blanco_ufc) || '' %>"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Siembra -->
    <div class="mb-4">
      <div class="bg-light border fw-bold text-center py-2 px-3 rounded-top">Siembra</div>
      <div class="border border-top-0 rounded-bottom p-3">
        <div class="row g-2">
          <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="siembra_tiempo_ok" name="siembra_tiempo_ok" <%= (data && data.siembra_tiempo_ok) ? 'checked' : '' %> >
          <label class="form-check-label" for="siembra_tiempo_ok">Tiempo entre homogenizado y siembra &lt; 15 minutos</label>
        </div>
          <div class="col-sm-8 col-md-5">
            <label class="form-label small mb-1">N° de Muestra (10gr/90ml)</label>
            <input type="text" name="siembra_n_muestra_10g_90ml" class="form-control" value="<%= (data && data.siembra_n_muestra_10g_90ml) || '' %>">
          </div>
          <div class="col-sm-8 col-md-4">
            <label class="form-label small mb-1">N° de Muestra (50gr/450ml)</label>
            <input type="text" name="siembra_n_muestra_50g_450ml" class="form-control" value="<%= (data && data.siembra_n_muestra_50g_450ml) || '' %>">
          </div>
        </div>
      </div>
    </div>

    <!-- Control de Calidad -->
    <div class="mb-4">
      <div class="bg-light border fw-bold text-center py-2 px-3 rounded-top">Controles de Calidad</div>
      <div class="border border-top-0 rounded-bottom p-3">
      <div class="table-responsive">
        <table class="table table-bordered align-middle mb-0">
        <thead>
          <tr class="text-center">
            <th style="width: 20%">Ítem</th>
            <th style="width: 30%">Análisis</th>
            <th style="width: 25%">Cumple</th>
            <th style="width: 25%">No Cumple</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="fw-semibold">Duplicado en ALI</td>
            <td><input type="text" name="cc_duplicado_ali_analisis" class="form-control" value="<%= (data && data.cc_duplicado_ali_analisis) || '' %>"></td>
            <td class="text-center">
              <input class="form-check-input" type="radio" name="cc_duplicado_ali_cumple" value="1" <%= (data && String(data.cc_duplicado_ali_cumple) === '1') ? 'checked' : '' %> >
            </td>
            <td class="text-center">
              <input class="form-check-input" type="radio" name="cc_duplicado_ali_cumple" value="0" <%= (data && String(data.cc_duplicado_ali_cumple) === '0') ? 'checked' : '' %> >
            </td>
          </tr>
          <tr>
            <td class="fw-semibold">Control (+) y Blanco en ALI</td>
            <td><input type="text" name="cc_control_pos_blanco_ali_analisis" class="form-control" value="<%= (data && data.cc_control_pos_blanco_ali_analisis) || '' %>"></td>
            <td class="text-center">
              <input class="form-check-input" type="radio" name="cc_control_pos_blanco_ali_cumple" value="1" <%= (data && String(data.cc_control_pos_blanco_ali_cumple) === '1') ? 'checked' : '' %> >
            </td>
            <td class="text-center">
              <input class="form-check-input" type="radio" name="cc_control_pos_blanco_ali_cumple" value="0" <%= (data && String(data.cc_control_pos_blanco_ali_cumple) === '0') ? 'checked' : '' %> >
            </td>
          </tr>
          <tr>
            <td class="fw-semibold">Control de Siembra en ALI</td></td>
            <td><input type="text" name="cc_control_siembra_ali_analisis" class="form-control" value="<%= (data && data.cc_control_siembra_ali_analisis) || '' %>"></td>
            <td class="text-center">
              <input class="form-check-input" type="radio" name="cc_control_siembra_ali_cumple" value="1" <%= (data && String(data.cc_control_siembra_ali_cumple) === '1') ? 'checked' : '' %> >
            </td>
            <td class="text-center">
              <input class="form-check-input" type="radio" name="cc_control_siembra_ali_cumple" value="0" <%= (data && String(data.cc_control_siembra_ali_cumple) === '0') ? 'checked' : '' %> >
            </td>
          </tr>
          
        </tbody>
        </table>
      </div>
      </div>
    </div>


    <!-- MIC Parte II Sección III Cap IV pto 1 y 2 -->
    <div class="mb-4">
      <div class="bg-light border fw-bold text-center py-2 px-3 rounded-top">Manual de Inocuidad y Certificación Parte II Sección III Cap IV pto 1 y 2</div>
      <div class="border border-top-0 rounded-bottom p-3">
        <div class="table-responsive">
          <table class="table table-bordered align-middle mb-0">
            <tbody>
              <tr>
                <td class="fw-semibold" style="width: 25%">Desfavorable:</td>
                <td class="text-center" style="width: 10%">
                  <div class="form-check d-inline-block">
                    <input class="form-check-input" type="checkbox" id="mic_desfavorable_si" name="mic_desfavorable_si" <%= (data && data.mic_desfavorable_si) ? 'checked' : '' %> >
                    <label class="form-check-label ms-1" for="mic_desfavorable_si">SI</label>
                  </div>
                </td>
                <td class="text-center" style="width: 10%">
                  <div class="form-check d-inline-block">
                    <input class="form-check-input" type="checkbox" id="mic_desfavorable_no" name="mic_desfavorable_no" <%= (data && data.mic_desfavorable_no) ? 'checked' : '' %> >
                    <label class="form-check-label ms-1" for="mic_desfavorable_no">NO</label>
                  </div>
                </td>
                <td></td>
              </tr>
              <tr>
                <td class="fw-semibold">Tabla/Página:</td>
                <td colspan="2"><input type="text" name="mic_tabla_pagina" class="form-control" value="<%= (data && data.mic_tabla_pagina) || '' %>"></td>
                <td class="fw-semibold">Límite:
                  <input type="text" name="mic_limite" class="form-control mt-1" value="<%= (data && data.mic_limite) || '' %>">
                </td>
              </tr>
              <tr>
                <td class="fw-semibold">Fecha y hora de entrega:</td>
                <td style="width: 20%">
                  <input type="date" name="mic_fecha_entrega" class="form-control" value="<%= (data && data.mic_fecha_entrega) || '' %>">
                </td>
                <td style="width: 20%">
                  <input type="time" name="mic_hora_entrega" class="form-control" value="<%= (data && data.mic_hora_entrega) || '' %>">
                </td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Datos -->
    <div class="mb-4">
      <div class="bg-light border fw-bold text-center py-2 px-3 rounded-top">Datos</div>
      <div class="border border-top-0 rounded-bottom p-3">
        <div class="row g-3 align-items-end mb-3">
          <div class="col-md-6">
            <label class="form-label">Suspension Inicial 1/:</label>
            <input type="text" name="datos_suspension_inicial_den" class="form-control" style="font-weight:700" value="<%= (data && data.datos_suspension_inicial_den) || '' %>">
          </div>
          <div class="col-md-6">
            <label class="form-label">Volumen/Petri dish [mL]:</label>
            <input type="text" name="datos_volumen_petri_ml" class="form-control" style="font-weight:700" value="<%= (data && data.datos_volumen_petri_ml) || '' %>">
          </div>
          <div class="col-md-6">
            <label class="form-label">Dilución (log10) fila 1</label>
            <input type="text" id="dil_exp1" name="datos_dilucion_log10_1" class="form-control" placeholder="Ej: -2 (para 10^-2)" value="<%= (data && data.datos_dilucion_log10_1) || '' %>">
            <div class="form-text">Las siguientes filas se calculan restando 1 por fila.</div>
          </div>
        </div>

        <!-- Tabla de Dilución y Colonias (5 filas, Lámina A/B) -->
        <div class="table-responsive">
          <table class="table table-bordered align-middle mb-0">
            <thead>
              <tr class="text-center">
                <th rowspan="2" style="width:8%">Dilución</th>
                <th colspan="2">N° Colonias</th>
                <th colspan="2">Colonias por confirmar</th>
                <th colspan="2">Colonias confirmadas</th>
                <th colspan="2">N° final de colonias</th>
              </tr>
              <tr class="text-center">
                <th>Lámina A</th><th>Lámina B</th>
                <th>Lámina A</th><th>Lámina B</th>
                <th>Lámina A</th><th>Lámina B</th>
                <th>Lámina A</th><th>Lámina B</th>
              </tr>
            </thead>
            <tbody>
              <% for (let i = 1; i <= 5; i++) { %>
                <tr>
                  <td class="text-center fw-semibold"><%= i %></td>
                  <td><input type="text" name="datos_colonias_num_a_<%= i %>" class="form-control form-control-sm" value="<%= (data && data['datos_colonias_num_a_'+i]) || '' %>"></td>
                  <td><input type="text" name="datos_colonias_num_b_<%= i %>" class="form-control form-control-sm" value="<%= (data && data['datos_colonias_num_b_'+i]) || '' %>"></td>
                  <td><input type="text" name="datos_colonias_por_conf_a_<%= i %>" class="form-control form-control-sm" value="<%= (data && data['datos_colonias_por_conf_a_'+i]) || '' %>"></td>
                  <td><input type="text" name="datos_colonias_por_conf_b_<%= i %>" class="form-control form-control-sm" value="<%= (data && data['datos_colonias_por_conf_b_'+i]) || '' %>"></td>
                  <td><input type="text" name="datos_colonias_conf_a_<%= i %>" class="form-control form-control-sm" value="<%= (data && data['datos_colonias_conf_a_'+i]) || '' %>"></td>
                  <td><input type="text" name="datos_colonias_conf_b_<%= i %>" class="form-control form-control-sm" value="<%= (data && data['datos_colonias_conf_b_'+i]) || '' %>"></td>
                  <td><input type="text" name="datos_colonias_final_a_<%= i %>" class="form-control form-control-sm" readonly></td>
                  <td><input type="text" name="datos_colonias_final_b_<%= i %>" class="form-control form-control-sm" readonly></td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>

        <!-- Resultados compactos -->
        <div class="row g-3 mt-3">
          <div class="col-md-6">
            <div class="border rounded p-3 h-100">
              <div class="fw-bold mb-1">Número de CFU/g o mL</div>
              <div id="res_cfu" class="form-control text-center fw-bold" style="background:#fffef0">—</div>
              <div class="small text-muted mt-2">Formato: notación científica (1 cifra). Usa diluciones 1..5 según disponibilidad.</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="border rounded p-3 h-100">
              <div class="fw-bold mb-2">Aceptación por dilución (paralelo)</div>
              <div class="d-flex flex-wrap gap-2" id="res_ok_badges">
                <!-- badges dinámicos -->
              </div>
              <div class="small text-muted mt-2">Criterio P&gt;0.01 (α=0.01), basado en chi-cuadrado (2 duplicados).</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mb-4">
      <div class="bg-light border fw-bold text-center py-2 px-3 rounded-top">Observaciones</div>
      <div class="border border-top-0 rounded-bottom p-3">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Observaciones</label>
            <textarea name="observaciones" class="form-control" rows="3"><%= (data && data.observaciones) || '' %></textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4">
      <div style="width:320px;">
        <hr>
        <div class="text-center fw-bold">FIRMA COORDINADOR DE ÁREA</div>
      </div>
      <div>
        <button class="btn btn-primary" type="submit">Guardar RAM</button>
      </div>
    </div>

    <% if (message) { %>
      <div class="alert alert-info mt-3"><%= message %></div>
    <% } %>
  </form>
</div>

<script>
  (function(){
    const btn = document.getElementById('btnSaveAll');
    if (!btn) return;
    btn.addEventListener('click', async function(){
      const sampleInput = document.querySelector('input[name="sample_id"]');
      const sampleId = sampleInput ? sampleInput.value.trim() : '';
      if (!sampleId) { alert('Ingrese sample_id y cargue la muestra primero.'); return; }
      try {
        const res = await fetch('/form-ram/save-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sample_id: sampleId })
        });
        const data = await res.json();
        if (data && data.ok) {
          alert('Guardado en todas las pestañas realizado.');
        } else {
          alert('No se pudo guardar en todas: ' + (data.error || 'Error desconocido'));
        }
      } catch (err) {
        alert('Error al guardar en todas: ' + err.message);
      }
    });
  })();

  // Cálculos en vivo de RAM
  (function(){
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const parseNum = (v) => {
      if (v == null) return null;
      const s = String(v).trim().replace(',', '.');
      if (s === '') return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    };
    const chiCDF_k1 = (x) => {
      // CDF for chi-square with k=1: CDF(x)=erf(sqrt(x/2))
      if (x <= 0 || !Number.isFinite(x)) return 0;
      const t = Math.sqrt(x/2);
      // erf approximation (Abramowitz-Stegun)
      const erf = (z) => {
        const sign = z < 0 ? -1 : 1;
        const a1=0.254829592, a2=-0.284496736, a3=1.421413741, a4=-1.453152027, a5=1.061405429, p=0.3275911;
        const x = Math.abs(z);
        const t = 1/(1+p*x);
        const y = 1-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*Math.exp(-x*x);
        return sign*y;
      };
      return Math.max(0, Math.min(1, erf(t)));
    };

    const inputs = $$('input[name^="datos_colonias_"], input[name="datos_volumen_petri_ml"], input[name="datos_suspension_inicial_den"], #dil_exp1');
    const finalA = [null, ...$$('input[name^="datos_colonias_final_a_"]')];
    const finalB = [null, ...$$('input[name^="datos_colonias_final_b_"]')];
    const resCFU = $('#res_cfu');
    const badges = $('#res_ok_badges');

    function counTA(vals){ return vals.filter(v => v !== null && v !== '').length; }

    function recalc(){
      const vol = parseNum($('input[name="datos_volumen_petri_ml"]').value);
      const den = parseNum($('input[name="datos_suspension_inicial_den"]').value);
      const exp1 = parseNum($('#dil_exp1').value);
      // per fila
      const C = [null], D=[null], F=[null], G=[null], H=[null], I=[null], J=[null], K=[null];
      for(let i=1;i<=5;i++){
        C[i] = parseNum($(`input[name="datos_colonias_num_a_${i}"]`).value);
        D[i] = parseNum($(`input[name="datos_colonias_num_b_${i}"]`).value);
        F[i] = parseNum($(`input[name="datos_colonias_por_conf_a_${i}"]`).value);
        G[i] = parseNum($(`input[name="datos_colonias_por_conf_b_${i}"]`).value);
        H[i] = parseNum($(`input[name="datos_colonias_conf_a_${i}"]`).value);
        I[i] = parseNum($(`input[name="datos_colonias_conf_b_${i}"]`).value);
        // J (A)
        let j='';
        if (F[i]!=null && C[i]!=null && F[i]>C[i]) j='ERROR';
        else if ((F[i]==null)!==(H[i]==null)) j='ERROR';
        else if (F[i]==null && H[i]==null) j='';
        else if (F[i]!=null && H[i]!=null){
          if (F[i] < H[i]) j='ERROR'; else j = C[i]!=null ? C[i]*(H[i]/(F[i]===0?1:F[i])) : '';
        }
        J[i]=j; if (finalA[i]) finalA[i].value = (j==='ERROR'||j==='')? j : String(Math.round(j*1000)/1000);
        // K (B)
        let k='';
        if (G[i]!=null && D[i]!=null && G[i]>D[i]) k='ERROR';
        else if ((G[i]==null)!==(I[i]==null)) k='ERROR';
        else if (G[i]==null && I[i]==null) k='';
        else if (G[i]!=null && I[i]!=null){
          if (G[i] < I[i]) k='ERROR'; else k = D[i]!=null ? D[i]*(I[i]/(G[i]===0?1:G[i])) : '';
        }
        K[i]=k; if (finalB[i]) finalB[i].value = (k==='ERROR'||k==='')? k : String(Math.round(k*1000)/1000);
      }

      // Validaciones presencia
      const q25 = (vol!=null && den!=null && exp1!=null);
      // q26: ¿hay datos primeros dos?
      const q26 = !!( (C[1]!=null||D[1]!=null||F[1]!=null||G[1]!=null) || (C[2]!=null||D[2]!=null||F[2]!=null||G[2]!=null) );
      const anyFinal12 = !!( (J[1]!==''&&J[1]!=='ERROR') || (K[1]!==''&&K[1]!=='ERROR') || (J[2]!==''&&J[2]!=='ERROR') || (K[2]!==''&&K[2]!=='ERROR') );

      // Placas por dilución
      const countPlates = (i) => anyFinal12 ? counTA([F[i],G[i]]) : counTA([C[i],D[i]]);
      const q40 = countPlates(1);
      const q41 = countPlates(2);
      const q45 = countPlates(3);
      const q46 = countPlates(4);
      const q47 = countPlates(5);

      // Suma de finales (prefiere J/K; si no hay, suma crudos)
      const hasFinalAny = [1,2,3,4,5].some(i => (J[i]!==''&&J[i]!=='ERROR')||(K[i]!==''&&K[i]!=='ERROR'));
      const sumFinal = hasFinalAny ? [1,2,3,4,5].reduce((s,i)=> s + (Number(J[i])||0) + (Number(K[i])||0), 0)
                                   : [1,2,3,4,5].reduce((s,i)=> s + (Number(C[i])||0) + (Number(D[i])||0), 0);

      // Q39 factor de dilución
      let q39 = null;
      if (den!=null && exp1!=null){
        if (den===1) q39 = Math.pow(10, exp1);
        else q39 = (1/den) * Math.pow(10, exp1+1);
      }
      // Q42 volumen ponderado
      const q42 = (vol!=null) ? vol * ( q40 + 0.1*q41 + 0.01*q45 + 0.001*q46 + 0.0001*q47 ) : null;
      // Resultado E (E38/E15)
      let res = null;
      if (q25 && q26 && q39!=null && q42!=null){
        if (sumFinal===0) res = 1/(q39*(vol||1)); else res = sumFinal/(q42*q39);
      }
      resCFU.textContent = (res==null || !Number.isFinite(res)) ? '—' : Number(res).toExponential(1).replace('e+','E+').replace('e-','E-');

      // Aceptación por dilución (1..5) usando duplicados (C,D) => chi-cuadrado
      const alpha = 0.01; // Q44=0.99 => 1-Q44=0.01
      const ok = [];
      function perRowOK(i){
        const a = C[i], b = D[i];
        const n = counTA([a,b]);
        if (res==null || !Number.isFinite(res)) return 'NOT APPLICABLE';
        if ((a==null && b==null) || n<2) return 'NOT APPLICABLE';
        const min = Math.min(a||0,b||0), max = Math.max(a||0,b||0);
        if (max===0) return 'NOT APPLICABLE';
        const avg = (min+max)/2;
        const x = 2*(min*Math.log((min===0?1:min)/avg) + max*Math.log(max/avg));
        const p = 1 - chiCDF_k1(x);
        return (p > alpha) ? 'YES' : 'NO';
      }
      for (let i=1;i<=5;i++) ok[i]=perRowOK(i);
      badges.innerHTML = '';
      for (let i=1;i<=5;i++){
        const span = document.createElement('span');
        const v = ok[i];
        const cls = v==='YES' ? 'bg-success' : (v==='NO' ? 'bg-danger' : 'bg-secondary');
        span.className = `badge ${cls}`;
        span.textContent = `${i}ª: ${v}`;
        badges.appendChild(span);
      }
    }
    inputs.forEach(el => el.addEventListener('input', recalc));
    recalc();
  })();
</script>
