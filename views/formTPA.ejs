<% layout('partials/layout') %>
<h2>Formulario de Trazabilidad (TPA)</h2>
<form method="get" action="/form-tpa" class="row g-2 mb-3">
  <div class="col-auto">
    <input type="text" name="sample_id" class="form-control" placeholder="sample_id" value="<%= (data && data.sample_id) || (sampleId||'') %>" required>
  </div>
  <div class="col-auto">
    <button class="btn btn-outline-info" type="submit">Cargar</button>
  </div>
  <div class="col-auto">
    <a class="btn btn-outline-secondary" href="/samples">Muestras</a>
  </div>
  <div class="col-auto">
    <a class="btn btn-outline-success" href="#" data-export-tpa>Exportar Excel</a>
  </div>
  
</form>

<%- include('partials/formTabs', { active: 'TPA', sampleId: (data && data.sample_id) || sampleId }) %>

<% if (message) { %>
  <div class="alert alert-info"><%= message %></div>
<% } %>

<form method="post" action="/form-tpa/save" class="card p-3 mb-4">
  <div class="mb-3">
    <label class="form-label">sample_id</label>
    <input type="text" name="sample_id" class="form-control" value="<%= (data && data.sample_id) || (sampleId||'') %>" required>
  </div>

  <div class="card p-3 mb-3">
    <h5>Almacenamiento</h5>
    <div class="row">
      <div class="col-md-6">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="storage_freezer_33m" <%= (data && data.storage_freezer_33m) ? 'checked' : '' %> />
          <label class="form-check-label">Freezer 33-M</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="storage_refrigerador_33m" <%= (data && data.storage_refrigerador_33m) ? 'checked' : '' %> />
          <label class="form-check-label">Refrigerador 33-M</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="storage_meson_siembra" <%= (data && data.storage_meson_siembra) ? 'checked' : '' %> />
          <label class="form-check-label">Mesón siembra</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="storage_gabinete_traspaso" <%= (data && data.storage_gabinete_traspaso) ? 'checked' : '' %> />
          <label class="form-check-label">Gabinete sala Traspaso</label>
        </div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Observaciones</label>
        <textarea class="form-control" rows="4" name="observaciones"><%= (data && data.observaciones) || '' %></textarea>
      </div>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <h5 class="text-center">MANIPULACIÓN DE MUESTRAS (1)</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead>
          <tr>
            <th>Retiro</th>
            <th>Pesado</th>
            <th>Clave material pesado (Cuchara, Pinzas, Bisturí)</th>
            <th>Responsable</th>
            <th>Fecha</th>
            <th>Hora inicio</th>
            <th>Hora término</th>
            <th>Nº muestra</th>
          </tr>
        </thead>
        <tbody>
          <% for (let i=1;i<=3;i++){ %>
            <tr>
              <td class="text-center"><input type="checkbox" name="retiro_muestra_<%= i %>" <%= (data && data['retiro_muestra_'+i]) ? 'checked' : '' %> ></td>
              <td class="text-center"><input type="checkbox" name="pesado_<%= i %>" <%= (data && data['pesado_'+i]) ? 'checked' : '' %> ></td>
              <td>
                <div class="row g-2">
                  <div class="col-4"><label>Cuchara</label><input type="text" class="form-control" name="clave_material_<%= (i-1)*3+1 %>" value="<%= (data && data['clave_material_'+((i-1)*3+1)]) || '' %>"></div>
                  <div class="col-4"><label>Pinzas</label><input type="text" class="form-control" name="clave_material_<%= (i-1)*3+2 %>" value="<%= (data && data['clave_material_'+((i-1)*3+2)]) || '' %>"></div>
                  <div class="col-4"><label>Bisturí</label><input type="text" class="form-control" name="clave_material_<%= (i-1)*3+3 %>" value="<%= (data && data['clave_material_'+((i-1)*3+3)]) || '' %>"></div>
                </div>
              </td>
              <td><input type="text" class="form-control" name="responsable_<%= i %>" value="<%= (data && data['responsable_'+i]) || '' %>"></td>
              <td><input type="date" class="form-control" name="fecha_<%= i %>" value="<%= (data && data['fecha_'+i] ? data['fecha_'+i].toISOString ? data['fecha_'+i].toISOString().slice(0,10) : String(data['fecha_'+i]).slice(0,10) : '') %>"></td>
              <td><input type="time" class="form-control" name="hora_inicio_<%= i %>" value="<%= (data && data['hora_inicio_'+i]) || '' %>"></td>
              <td><input type="time" class="form-control" name="hora_termino_<%= i %>" value="<%= (data && data['hora_termino_'+i]) || '' %>"></td>
              <td><input type="text" class="form-control" name="n_muestra_<%= i %>" value="<%= (data && data['n_muestra_'+i]) || '' %>"></td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th colspan="6" class="text-center">Equipos para Pesado</th>
            <th colspan="3" class="text-center">Lugar de almacenamiento</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="text-center"><input type="checkbox" name="equipo_balanza_74m" <%= (data && data.equipo_balanza_74m) ? 'checked' : '' %> ><br>Balanza 74-M</td>
            <td class="text-center"><input type="checkbox" name="equipo_camara_8m" <%= (data && data.equipo_camara_8m) ? 'checked' : '' %> ><br>Cámara flujo laminar 8-M</td>
            <td class="text-center"><input type="checkbox" name="equipo_balanza_6m" <%= (data && data.equipo_balanza_6m) ? 'checked' : '' %> ><br>Balanza 6-M</td>
            <td class="text-center"><input type="checkbox" name="equipo_meson_traspaso" <%= (data && data.equipo_meson_traspaso) ? 'checked' : '' %> ><br>Mesón de traspaso</td>
            <td class="text-center"><input type="checkbox" name="equipo_balanza_99m" <%= (data && data.equipo_balanza_99m) ? 'checked' : '' %> ><br>Balanza 99-M</td>
            <td class="text-center"><input type="checkbox" name="equipo_balanza_108m" <%= (data && data.equipo_balanza_108m) ? 'checked' : '' %> ><br><b>Balanza 108-M</b></td>
            <td class="text-center"><input type="checkbox" name="equipo_freezer_33m" <%= (data && data.equipo_freezer_33m) ? 'checked' : '' %> ><br>Freezer 33-M</td>
            <td class="text-center"><input type="checkbox" name="equipo_refrigerador_33m" <%= (data && data.equipo_refrigerador_33m) ? 'checked' : '' %> ><br>Refrigerador 33-M</td>
            <td class="text-center"><input type="checkbox" name="equipo_gabinete_traspaso" <%= (data && data.equipo_gabinete_traspaso) ? 'checked' : '' %> ><br>Gabinete de Traspaso</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5 class="text-center">Uso y limpieza de Micropipetas</h5>
        <div class="row">
          <div class="col-6">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th colspan="2" class="text-center">1 ml</th>
                  <th colspan="2" class="text-center">10 ml</th>
                </tr>
              </thead>
              <tbody>
                <% const mpRows = [
                  ['22-M','micropipeta_22m','32-M','micropipeta_32m'],
                  ['23-M','micropipeta_23m','75-M','micropipeta_75m'],
                  ['72-M','micropipeta_72m','94-M','micropipeta_94m'],
                  ['98-M','micropipeta_98m','103-M','micropipeta_103m'],
                  ['100-M','micropipeta_100m','',''],
                  ['102-M','micropipeta_102m','',''],
                  ['\u003cb\u003e106-M\u003c/b\u003e','micropipeta_106m','',''],
                ]; %>
                <% mpRows.forEach(row => { %>
                  <tr>
                    <td class="text-center"><%- row[0] %></td>
                    <td class="text-center"><% if (row[1]) { %><input type="checkbox" name="<%= row[1] %>" <%= (data && data[row[1]]) ? 'checked' : '' %> ><% } %></td>
                    <td class="text-center"><%- row[2] %></td>
                    <td class="text-center"><% if (row[3]) { %><input type="checkbox" name="<%= row[3] %>" <%= (data && data[row[3]]) ? 'checked' : '' %> ><% } %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <div class="col-6">
            <table class="table table-bordered">
              <tbody>
                <tr>
                  <th>Puntas/pipetas 1ml/clave</th>
                  <td><input type="text" class="form-control" name="clave_1ml" value="<%= (data && data.clave_1ml) || '' %>"></td>
                </tr>
                <tr>
                  <th>Puntas/pipetas 10ml/clave</th>
                  <td><input type="text" class="form-control" name="clave_10ml" value="<%= (data && data.clave_10ml) || '' %>"></td>
                </tr>
                <tr>
                  <th>Otros</th>
                  <td><input type="text" class="form-control" name="clave_otros" value="<%= (data && data.clave_otros) || '' %>"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5 class="text-center">Limpieza</h5>
        <table class="table table-bordered">
          <tbody>
            <% const limpieza = [
              ['Mesón','limpieza_meson'],
              ['Stomacher 12-M','limpieza_stomacher'],
              ['Cámara flujo laminar 8-M','limpieza_camara'],
              ['Balanza 74-M 108-M','limpieza_balanza'],
              ['Balanza 6-M 99-M','limpieza_balanza2'],
            ]; %>
            <% limpieza.forEach(item => { %>
              <tr>
                <td><%- item[0] %></td>
                <td class="text-center"><input type="checkbox" name="<%= item[1] %>" <%= (data && data[item[1]]) ? 'checked' : '' %> ></td>
              </tr>
            <% }) %>
            <tr>
              <td>Otros</td>
              <td><input type="text" class="form-control" name="limpieza_otros" value="<%= (data && data.limpieza_otros) || '' %>"></td>
            </tr>
            <tr>
              <td>Desinfectante en aerosol</td>
              <td class="text-center"><input type="checkbox" name="limpieza_aerosol" <%= (data && data.limpieza_aerosol) ? 'checked' : '' %> ></td>
            </tr>
          </tbody>
        </table>
        <label>Observaciones limpieza</label>
        <textarea class="form-control" rows="4" name="observaciones_limpieza"><%= (data && data.observaciones_limpieza) || '' %></textarea>
      </div>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <h5 class="text-center">Material y equipos de Siembra</h5>
    <div class="table-responsive">
      <table class="table table-bordered">
        <tbody>
          <tr>
            <th>Clave</th>
            <td colspan="3"><input type="text" class="form-control" name="clave_general" value="<%= (data && data.clave_general) || '' %>"></td>
          </tr>
          <% const siembra = [
            ['Puntas 1mL:','clave_puntas_1ml','Baño 5-M:','bano_5m'],
            ['Puntas 10 mL:','clave_puntas_10ml','Homogenizador 12-M:','homogenizador_12m'],
            ['Placas estériles: 57cm2 / 150 mm','clave_placas','Cuenta colonias 9-M:','cuenta_colonias_9m'],
            ['Asas Drigalsky:','clave_asas','Cuenta colonias 101-M:','cuenta_colonias_101m'],
            ['Blender:','clave_blender','pHmetro 93-M:','phmetro_93m'],
            ['Bolsas estériles:','clave_bolsas','Pipetas desechables:','pipetas_desechables'],
            ['Probeta 250 ml / 100 ml','clave_probeta','Otro:','clave_otro'],
          ]; %>
          <% siembra.forEach(row => { %>
            <tr>
              <td><%- row[0] %></td>
              <td><input type="text" class="form-control" name="<%= row[1] %>" value="<%= (data && data[row[1]]) || '' %>"></td>
              <td><%- row[2] %></td>
              <td class="text-center">
                <% if (row[2].indexOf(':') !== -1) { %>
                  <input type="checkbox" name="<%= row[3] %>" <%= (data && data[row[3]]) ? 'checked' : '' %> >
                <% } else { %>
                  <input type="text" class="form-control" name="<%= row[3] %>" value="<%= (data && data[row[3]]) || '' %>">
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <h5 class="text-center">Diluyentes</h5>
    <div class="table-responsive">
      <table class="table table-bordered">
        <tbody>
          <% const diluyentes = [
            ['AP 0,1% 90 ml:','ap_90ml','AP 0,1% tubos ml:','ap_tubos_ml'],
            ['AP 0,1% 99 ml:','ap_99ml','SPS 225 ml:','sps_225ml'],
            ['AP 0,1% 450 ml:','ap_450ml','SPS Tubos:','sps_tubos'],
            ['AP 0,1% 225 ml:','ap_225ml','SPS sa 90 ml:','sps_sa_90ml'],
            ['AP 0,1% 500 ml:','ap_500ml','SPS sa tubos:','sps_sa_tubos'],
            ['PBS 450 ml:','pbs_450ml','Otro:','diluyente_otro'],
            ['Otros:','diluyente_otros1','', ''],
          ]; %>
          <% diluyentes.forEach(row => { %>
            <tr>
              <td><%- row[0] %></td>
              <td><input type="text" class="form-control" name="<%= row[1] %>" value="<%= (data && data[row[1]]) || '' %>"></td>
              <% if (row[2]) { %>
                <td><%- row[2] %></td>
                <td>
                  <% if (row[2].indexOf(':') !== -1) { %>
                    <input type="text" class="form-control" name="<%= row[3] %>" value="<%= (data && data[row[3]]) || '' %>">
                  <% } %>
                </td>
              <% } else { %>
                <td colspan="2"><input type="text" class="form-control" name="<%= row[1] %>" value="<%= (data && data[row[1]]) || '' %>"></td>
              <% } %>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <div class="d-flex justify-content-end mb-3">
    <div style="width:320px;">
      <hr>
      <div class="text-center fw-bold">FIRMA COORDINADOR DE ÁREA</div>
    </div>
  </div>

  <div class="text-center">
    <button type="submit" class="btn btn-primary btn-lg">Guardar</button>
  </div>
</form>
